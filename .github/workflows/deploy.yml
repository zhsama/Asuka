# Workflow åç§°ï¼Œåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤º
name: Deploy to Cloudflare Workers

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å½“æ¨é€åˆ°æŒ‡å®šåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - master    # ä¸»åˆ†æ”¯
      - main      # å¤‡ç”¨ä¸»åˆ†æ”¯å
  # å…è®¸æ‰‹åŠ¨è§¦å‘ workflow
  workflow_dispatch:

# å®šä¹‰ workflow ä¸­çš„ä½œä¸š
jobs:
  # éƒ¨ç½² Blog åº”ç”¨çš„ä½œä¸š
  deploy-blog:
    # ä½œä¸šæ˜¾ç¤ºåç§°
    name: Deploy Blog to Cloudflare Workers
    # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°ç‰ˆ Ubuntu
    runs-on: ubuntu-latest
    # ä½œä¸šæ­¥éª¤
    steps:
      # æ£€å‡ºä»£ç åˆ°è¿è¡Œå™¨
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® pnpm åŒ…ç®¡ç†å™¨
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          # æŒ‡å®š pnpm ç‰ˆæœ¬ï¼Œä¸é¡¹ç›®ä¿æŒä¸€è‡´
          version: 10.10.0

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js ç‰ˆæœ¬
          node-version: '20'
          # ä½¿ç”¨ pnpm ç¼“å­˜ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
          cache: 'pnpm'

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # æ„å»º blog åº”ç”¨
      - name: Build blog
        run: pnpm build:blog

      # éƒ¨ç½²åˆ° Cloudflare Workers
      - name: Deploy blog to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          # Cloudflare API Tokenï¼ˆä» GitHub Secrets è¯»å–ï¼‰
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # Cloudflare è´¦æˆ· IDï¼ˆä» GitHub Secrets è¯»å–ï¼‰
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # å·¥ä½œç›®å½•ï¼Œwrangler.toml æ‰€åœ¨ä½ç½®
          workingDirectory: 'apps/blog'
          # Wrangler CLI ç‰ˆæœ¬
          wranglerVersion: 'latest'
          # æ‰§è¡Œçš„ wrangler å‘½ä»¤ï¼Œ--env æŒ‡å®šç¯å¢ƒ
          command: deploy --env production

  # éƒ¨ç½² Main åº”ç”¨çš„ä½œä¸š
  deploy-main:
    # ä½œä¸šæ˜¾ç¤ºåç§°
    name: Deploy Main to Cloudflare Workers
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # ä½œä¸šæ­¥éª¤ï¼ˆä¸ blog éƒ¨ç½²ç±»ä¼¼ï¼‰
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.10.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build main
        run: pnpm build:main

      - name: Deploy main to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'apps/main'
          wranglerVersion: 'latest'
          command: deploy --env production

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥ä½œä¸š
  comment-deployment-status:
    # ä½œä¸šæ˜¾ç¤ºåç§°
    name: Comment Deployment Status
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # ä¾èµ–å…¶ä»–ä½œä¸šå®Œæˆ
    needs: [deploy-blog, deploy-main]
    # æ¡ä»¶æ‰§è¡Œï¼šä»…åœ¨ push äº‹ä»¶è§¦å‘æ—¶è¿è¡Œ
    if: github.event_name == 'push'
    steps:
      # ä½¿ç”¨ GitHub Script åˆ›å»ºè¯„è®º
      - name: Comment deployment URLs
        uses: actions/github-script@v7
        with:
          # JavaScript è„šæœ¬ï¼Œç”¨äºåˆ›å»ºè¯„è®º
          script: |
            // æ„å»ºéƒ¨ç½²æˆåŠŸæ¶ˆæ¯
            const deploymentMessage = `
            ğŸš€ **Deployment Successful!**
            
            - Blog: https://blog.zhsama.xyz
            - Main: https://me.zhsama.xyz
            
            Deployed at: ${new Date().toISOString()}
            `;
            
            // ä»…åœ¨ PR ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºè¯„è®º
            if (context.payload.pull_request) {
              // è°ƒç”¨ GitHub API åˆ›å»ºè¯„è®º
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: deploymentMessage
              });
            }